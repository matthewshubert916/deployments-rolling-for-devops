---
- hosts: varnish
  sudo: yes

  tasks:
    - name: Add Varnish repository.
      command: >
        rpm --nosignature -i http://repo.varnish-cache.org/redhat/varnish-3.0/el6/noarch/varnish-release/varnish-release-3.0-1.el6.noarch.rpm
        creates=/var/lib/yum/repos/x86_64/6/varnish-3.0

    - name: Install Varnish.
      yum: name=varnish state=installed

    - name: Copy Varnish configuration files.
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
      notify: restart varnish
      with_items:
        - { src: templates/default.vcl, dest: /etc/varnish/default.vcl }
        - { src: templates/varnish, dest: /etc/sysconfig/varnish }

    - name: Ensure Varnish is started and set to run on startup.
      service: name=varnish state=started enabled=yes

  handlers:
    - name: restart varnish
      service: name=varnish state=restarted
